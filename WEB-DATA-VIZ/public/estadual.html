<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InovMed | Dashboards</title>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="./js/estadual.js" defer></script>
    <script src="./js/sessao.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="./css/estadual.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="icon" href="assets/icon/logo fundo azul.png" type="image/x-icon" />

    <!-- Chart.js e adaptador date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>

    <body onload="verificarAlertasMedicamentos()">


        <!-- Alerta completo -->
        <div id="alerta-estilizado" class="alerta-esconder">
            <div class="alerta-conteudo">
                <span id="alerta-mensagem"></span>
                <button id="alerta-fechar">&times;</button>
            </div>
        </div>


        <!-- Badge separado, aparece quando alerta est√° escondido -->
        <div id="alerta-badge" class="alerta-badge-esconder" title="Clique para abrir o alerta">
            <span class="badge-icone">üîî</span>
            <span class="badge-texto">
                Alerta: Seus par√¢metros de medicamento foram atingidos! Verifique seu estoque.
            </span>
        </div>
        <div class="janela">

            <div class="header-left">
                <img src="./assets/imgs/logo plus branca sem fundo.png" alt="Logo InovMed" class="logo" />

                <div class="nav-icons">
                    <div class="btn-nav-white active" onclick="abrirDashboard()">
                        <i class="fas fa-chart-bar"></i>
                    </div>

                    <div class="btn-nav" onclick="abrirPerfil()">
                        <i class="fa-solid fa-circle-user"></i>
                    </div>

                    <div class="btn-nav-white" id="novo_user" onclick="abrirConfiguracoes()">
                        <i class="fas fa-gear"></i>
                    </div>
                </div>

                <div class="btn-logout" onclick="limparSessao()">
                    <i class="fa-solid fa-power-off"></i>
                </div>

            </div>

            <div class="dash-estadual" id="dash_estadual">
                <div class="header-dashboard">
                    <h1 class="titulo-dashboard">
                        Ol√°, <span id="nomeUsuario"></span>!
                    </h1>
                    <div class="periodo-atual">
                        <p id="titulo-periodo-atual">
                            Estado atual:
                        </p>
                        <p id="estadoAtual"></p>
                        <p> | </p>
                        <p id="titulo-periodo-atual">
                            Per√≠odo atual:
                        </p>
                        <p id="periodoAtual"></p>
                    </div>
                </div>
                <div class="conteudo-dashboard-estadual">
                    <!-- Ini√≠cio KPIs -->

                    <div class="grupo-kpi">
                        <div class="kpi-container">
                            <h3 class="kpi-titulo">Quantidade de popula√ß√£o que sofre com asma
                            </h3>
                            <p class="kpi-valor1" id="qtdPopulacaoAsma"></p>

                        </div>
                        <div class="kpi-container">
                            <h3 class="kpi-titulo">% da popula√ß√£o com asma atendida com base na quantidade de
                                medicamento
                                dispon√≠vel
                            </h3>
                            <p class="kpi-valor1" id="PorcPopulacaoAtendida"></p>

                        </div>
                        <div class="kpi-container">
                            <h3 class="kpi-titulo">Meses com mais consumo de medicamentos
                            </h3>
                            <p class="kpi-valor1" id="MesesMaisConsumo">
                            </p>

                        </div>
                        <!-- Final KPIs -->

                    </div>
                    <div class="grupo-grafico">
                        <div class="grafico-container">
                            <select id="anoSelect">
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                            </select>
                            <canvas id="graficoHistorico"></canvas>
                        </div>
                        <!-- <div class="grafico-container">
                        <canvas id="graficoBarras"></canvas>
                    </div> -->
                        <div class="grafico-container">
                            <canvas id="graficoMunicipios"></canvas>
                        </div>
                        <!-- <div class="grafico-container">
                        <canvas id="graficoVencimento"></canvas>
                    </div> -->
                    </div>
                </div>

            </div>

            <div class="dash-perfil" id="dash_perfil">
                <div class="div_animacao">
                    <h1 id="title_hello">Seu perfil</h1>
                </div>
                <div class="perfil-container">
                    <h2 class="subtitulo">Dados Pessoais</h2>

                    <div class="input-group">
                        <div class="input-item">
                            <label for="nome">Nome Completo</label>
                            <i class="fa fa-user"></i>
                            <input type="text" id="nome" class="input-field" disabled>
                        </div>

                        <div class="input-item">
                            <label for="email">E-mail</label>
                            <i class="fa fa-envelope"></i>
                            <input type="email" id="email" class="input-field" disabled>
                        </div>

                        <div class="input-item">
                            <label for="cpf">CPF</label>
                            <i class="fa fa-id-card"></i>
                            <input type="text" maxlength="11" id="cpf" class="input-field" disabled>
                        </div>

                        <div class="input-item">
                            <label for="cargo">Cargo Exercido</label>
                            <i class="fa fa-briefcase"></i>
                            <select id="cargo" class="input-field" disabled>
                                <option value="outros"></option>
                                <option value="coordenador_estadual">Coordenador Estadual</option>
                                <option value="coordenador_municipal">Coordenador Municipal</option>
                            </select>
                        </div>

                        <div class="input-item">
                            <label for="estado">Estado em que atua</label>
                            <i class="fa fa-map-marker-alt"></i>
                            <select id="estado" class="input-field" disabled>
                                <option value="outros"></option>
                                <option value="1">Acre</option>
                                <option value="2">Amap√°</option>
                                <option value="3">Amazonas</option>
                                <option value="4">Par√°</option>
                                <option value="5">Rond√¥nia</option>
                                <option value="6">Roraima</option>
                                <option value="7">Tocantins</option>
                            </select>
                        </div>
                        <div id="input_item_municipio" class="input-item" style="display: none;">
                            <label for="municipio">Munic√≠pio em que atua</label>
                            <i class="fa fa-map-marker-alt"></i> <!-- √çcone para municipio -->
                            <select id="municipio" class="input-field" disabled>
                            </select>
                        </div>
                        <div class="input-item">
                            <label for="nascimento">Data de Nascimento</label>
                            <i class="fa fa-map-marker-alt"></i>
                            <input type="date" id="nascimento" class="input-field" disabled>
                        </div>
                        <div class="input-item">
                            <label for="genero">G√™nero</label>
                            <i class="fa fa-map-marker-alt"></i>
                            <select id="genero" name="genero" class="input-field" disabled>
                                <option value="">Selecione</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                                <option value="outro">Outro</option>
                                <option value="nao_informar">Prefiro n√£o informar</option>
                            </select>
                        </div>
                        <div class="input-item">
                            <label for="senha">Senha</label>
                            <i class="fa fa-lock"></i>
                            <input type="password" id="senha" class="input-field" disabled>
                        </div>
                    </div>
                    <div class="botoes-acoes">
                        <button class="btn-descartar" id="btn-descartar" onclick="descartarEdicao()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-editar" id="btn-editar" onclick="editarInformacoes()">
                            <i class="fas fa-pen"></i> Editar Informa√ß√µes
                        </button>

                        <button class="btn-salvar" id="btn-salvar" onclick="salvarInformacoes()" style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informa√ß√µes
                        </button>
                    </div>
                    <button class="delete-btn" onclick="excluirConta()">Excluir Conta</button>
                </div>
            </div>

            <div id="modal-confirm" class="modal-overlay hidden">
                <div class="modal-box">
                    <h2>Tem certeza que deseja excluir sua conta?</h2>
                    <p>Voc√™ n√£o ir√° mais ter acessos √† nossa plataforma e aos dados aqui inclusos</p>
                    <div class="modal-buttons">
                        <button id="cancel-delete" class="btn cancelar">Cancelar</button>
                        <button id="confirm-delete" class="btn confirmar">Excluir Conta</button>
                    </div>
                </div>
            </div>

            <div class="dash-config" id="dash_config">
                <div class="titulo-config">
                    <h1>Configura√ß√µes</h1>
                </div>

                <div class="opcao-config-container" id="opcao_config_container">
                    <div class="opcao-config-contato" onclick="abrirContatos()">
                        <div class="texto-config">
                            <h1>
                                Contato
                            </h1>
                            <p>
                                Defina onde √© importante voc√™ receber notifica√ß√µes sobre alertas e avisos
                            </p>
                        </div>
                        <div class="config-seta-imagem">
                            <img src="assets/icon/caret-right-light.png">
                        </div>
                    </div>
                    <div class="opcao-config-parametro" onclick="abrirParametros()">
                        <div class="texto-config">
                            <h1>
                                Par√¢metros
                            </h1>
                            <p>
                                Defina os par√¢metros e m√©tricas que fa√ßam sentido com sua realidade
                            </p>
                        </div>
                        <div class="config-seta-imagem">
                            <img src="assets/icon/caret-right-light.png">
                        </div>
                    </div>
                </div>


                <div class="dash-contato-container" id="dash_contato_container">
                    <h1 class="titulo-contato">
                        Contatos
                    </h1>

                    <div id="card_contatos"></div>
                    <!-- <div class="contato-container">
                    <div class="contato-container-cima">
                        <h1 class="nome-contato" id="nome_contato">
                            Contato 1
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="contato-container-input">
                        <p class="email-contato">
                            Email
                        </p>
                        <input type="text" id="input_email_contato" disabled>
                    </div>
                    <div class="botoes-acoes-contato">
                        <button class="btn-editar" id="btn-editar-contato" onclick="editarInformacoesContato()">
                            <i class="fas fa-pen"></i> Editar Informa√ß√µes
                        </button>
                        <button class="btn-descartar" id="btn-descartar-contato" onclick="descartarEdicaoContato()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-contato" onclick="salvarInformacoesContato()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informa√ß√µes
                        </button>
                    </div>
                </div> -->

                    <div class="adicionar-contato">
                        <div id="adicionar_contato" onclick="adicionarCardVazio()">
                            <img src="assets/icon/plus-circle-thin.png">
                        </div>
                    </div>
                </div>

                <div class="dash-parametro-container" id="dash_parametro_container">
                    <h1 class="titulo-parametro">
                        Par√¢metros
                    </h1>

                    <div id="card_parametro_medicamento"></div>
                    <!-- <div class="parametro-container" id="parametro-medicamento">
                    <div class="parametro-container-cima">
                        <h1 class="nome-parametro">
                        Medicamentos
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="parametro-container-input">
                        <p class="menor-valor-parametro">
                            Menor quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_menor_valor" disabled>
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja menor que esse valor, te notificaremos
                        </p>
                        <p class="maior-valor-parametro">
                            Maior quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_maior_valor" disabled>
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja maior que esse valor, te notificaremos
                        </p>
                    </div>
                    <div class="botoes-acoes-parametros">
                        <button class="btn-editar" id="btn-editar-parametro-medicamento" onclick="editarInformacoesParametroMedicamento()">
                            <i class="fas fa-pen"></i> Editar Informa√ß√µes
                        </button>
                        <button class="btn-descartar" id="btn-descartar-parametro-medicamento" onclick="descartarEdicaoParametroMedicamento()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-parametro-medicamento" onclick="salvarInformacoesParametroMedicamento()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informa√ß√µes
                    </div>
                </div> -->

                    <div id="card_parametro_grafico"></div>
                    <!-- <div class="parametro-container" id="parametro-grafico">
                    <div class="parametro-container-cima">
                        <h1 class="nome-parametro">
                        Gr√°fico - rem√©dios comprados por pessoas com asma por municipio
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="parametro-container-input">
                        <p class="menor-valor-parametro">
                            Porcentagem
                        </p>
                        <input type="text" id="input_parametro_grafico" disabled>
                        <p class="descricao-input-parametro">
                            Configure a porcentagem desejada para alterar a visualiza√ß√£o do gr√°fico.
                        </p>
                    </div>
                    <div class="botoes-acoes-parametros">
                        <button class="btn-editar" id="btn-editar-parametro-grafico" onclick="editarInformacoesParametroGrafico()">
                            <i class="fas fa-pen"></i> Editar Informa√ß√µes
                        </button>
                        <button class="btn-descartar" id="btn-descartar-parametro-grafico" onclick="descartarEdicaoParametroGrafico()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-parametro-grafico" onclick="salvarInformacoesParametroGrafico()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informa√ß√µes
                    </div>
                </div> -->

                    <div id="mensagem-parametro-inexistente"></div>

                    <div id="modal_parametro" class="modal-overlay hidden">
                        <div class="modal-box">
                            <h2>Qual par√¢metro voc√™ gostaria de adicionar?</h2>
                            <select id="select_parametro" class="select-parametro">
                                <option value="medicamento">Medicamento</option>
                                <option value="grafico">Gr√°fico</option>
                            </select>
                            <div class="modal-buttons">
                                <button id="cancel_add_parametro" class="btn-cancelar-parametro">Cancelar</button>
                                <button id="confirm_add_parametro" class="btn-confirmar-parametro">Adicionar
                                    Par√¢metro</button>
                            </div>
                        </div>
                    </div>

                    <div class="adicionar-contato">
                        <div id="adicionar_contato" onclick="criarModalParametro()">
                            <img src="assets/icon/plus-circle-thin.png">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </body>

</html>

<!-- <script src="./js/sessao.js"></script> -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const idEstado = sessionStorage.FK_ESTADO;


        carregarKPIPeriodoAtual();
        carregarGraficoHistorico();
        carregarGraficoMunicipios();
        carregarKPIQtdPopulacao();
        carregarKPIPopulacaoAtendida();
        carregarTopMesesEstoque();


        // KPI DE PER√çODO ATUAL
        function carregarKPIPeriodoAtual() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando per√≠odo atual da base:", idEstado);

            fetch(`/estados/periodoAtual/${idEstado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO periodoAtual()!");

                if (resposta.ok) {
                    console.log(resposta);
                    resposta.json().then(json => {
                        console.log(json); // Verifique o conte√∫do retornado
                        if (json.length > 0) {

                            estadoAtual.innerHTML = `${json[0].estado_atual}`

                            periodoAtual.innerHTML = `${json[0].periodo_atual}`

                        } else {
                            console.log("per√≠odo atual n√£o encontrada.");
                        }
                    });

                } else {
                    console.log("Houve um erro ao tentar realizar a busca de per√≠odo atual!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            }).catch(function (erro) {
                console.log(erro);
            });
        }

        // GR√ÅFICO DE HIST√ìRICO POR ESTADO

        const anoSelect = document.getElementById("anoSelect");
        if (anoSelect) {
            carregarGraficoHistorico(idEstado); // s√≥ chama se o select existir
            anoSelect.addEventListener("change", function () {
                carregarGraficoHistorico(idEstado);
            });
        } else {
            console.warn("Elemento #anoSelect n√£o encontrado no DOM.");
        }

        function gerarMesesIntervalo(ano, mesInicio, mesFim) {
            let meses = [];
            for (let m = mesInicio; m <= mesFim; m++) {
                // Adiciona zero √† esquerda no m√™s
                const mesStr = m.toString().padStart(2, '0');
                meses.push(`${mesStr}/${ano}`);
            }
            return meses;
        }

        const coresFixas = [
            'rgba(75, 192, 192, 1)',    // Verde
            'rgba(255, 99, 132, 1)',    // Vermelho
            'rgba(153, 102, 255, 1)',   // Roxo
            'rgba(255, 159, 64, 1)',    // Laranja
            'rgba(54, 162, 235, 1)',    // Azul
            // ... mais cores se quiser
        ];

        function carregarGraficoHistorico() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando hist√≥rico para o estado:", idEstado);

            const anoSelecionado = document.getElementById("anoSelect").value;

            console.log(`Buscando hist√≥rico para o munic√≠pio ${idEstado} no ano ${anoSelecionado}`);

            fetch(`/estados/historico/${idEstado}`)
                .then(res => {
                    if (!res.ok) throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
                    return res.json();
                })
                .then(dados => {
                    // Defina o intervalo fixo de meses que quer mostrar no gr√°fico:
                    const mesInicio = 1;
                    const mesFim = 12;
                    const meses = gerarMesesIntervalo(anoSelecionado, mesInicio, mesFim);

                    // const remedios = [...new Set(dados.map(item => item.remedio))];

                    // const datasets = remedios.map(remedio => ({
                    //     label: remedio,
                    //     data: meses.map(mes => {
                    //         const registro = dados.find(d => d.mes === mes && d.remedio === remedio);
                    //         return registro ? Number(registro.total_comprado) : 0;
                    //     }),
                    //     borderColor: gerarCorAleatoria(),
                    //     backgroundColor: 'transparent',
                    //     tension: 0.3,
                    //     borderWidth: 2,
                    //     pointRadius: 0,
                    // }));

                    // const mediaFixa = dados.length > 0 ? Number(dados[0].estimativa_asmaticos) : 0;

                    // // Preenche a m√©dia com o valor fixo para todos os meses
                    // const mediaAsmaticos = meses.map(() => mediaFixa);

                    // datasets.push({
                    //     label: 'M√©dia pessoas com asma',
                    //     data: mediaAsmaticos,
                    //     borderColor: 'rgba(75, 192, 192, 1)',
                    //     borderDash: [10, 5],
                    //     backgroundColor: 'transparent',
                    //     borderWidth: 2,
                    //     pointRadius: 0,
                    // });

                    const remedios = [...new Set(dados.map(item => item.remedio.trim()))];

                    const datasets = remedios.map((remedio, i) => {
                        const nomeCurto = remedio.split(' ').slice(0, 4).join(' ');
                        const valores = meses.map(mes => {
                            const registro = dados.find(d => {
                                const mesNormalizado = d.mes.replace('-', '/').trim();
                                return mesNormalizado === mes &&
                                    d.remedio.trim().toLowerCase() === remedio.trim().toLowerCase();
                            });
                            return registro ? Number(registro.total_comprado) : 0;
                        });

                        const cor = coresFixas[i % coresFixas.length];

                        return {
                            label: nomeCurto,
                            data: valores,
                            backgroundColor: cor,
                            borderColor: cor,
                            tension: 0.3,
                            pointRadius: 4
                        };
                        console.log("Rem√©dios √∫nicos:", remedios);
                    });

                    console.log("Dados recebidos:", dados);

                    console.log("Meses esperados:", meses);

                    const ctx = document.getElementById('graficoHistorico').getContext('2d');

                    // PROTE√á√ÉO PARA DESTRUIR O GR√ÅFICO APENAS SE EXISTIR
                    if (window.graficoHistorico && typeof window.graficoHistorico.destroy === 'function') {
                        window.graficoHistorico.destroy();
                    }

                    window.graficoHistorico = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: meses,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Hist√≥rico mensal de medicamentos comprados por estado em ${anoSelecionado}`,
                                    font: { size: 14, weight: 'bold' },
                                    padding: { top: 0, bottom: 5 }
                                },
                                legend: {
                                    position: 'top',
                                    labels: {
                                        boxWidth: 15,
                                        padding: 5
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Quantidade',
                                        font: { weight: 'bold', size: 12 }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Meses',
                                        font: { weight: 'bold', size: 12 }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => {
                    console.error("Erro no fetch:", err);
                    alert("Erro ao carregar dados do gr√°fico");
                });

        }

        document.getElementById("anoSelect").addEventListener("change", carregarGraficoHistorico);

        // GR√ÅFICO DE MUNIC√çPIOS COM POPULA√á√ÉO QUE RECEBE MENOS DE 50% DOS MEDICAMENTOS

        function carregarGraficoMunicipios() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando municipios para o estado:", idEstado);

            fetch(`/estados/municipios/${idEstado}`)
                .then(res => {
                    if (!res.ok) throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
                    return res.json();
                })
                .then(dados => {

                    const municipios = [...new Set(dados.map(item => item.municipio))];
                    const total_comprado = [...new Set(dados.map(item => item.total_comprado))];
                    const estimativa_asmaticos = [...new Set(dados.map(item => item.estimativa_asmaticos))];

                    const data = {
                        labels: municipios,
                        datasets: [
                            {
                                label: 'Total de Medicamentos Comprados',
                                data: total_comprado,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)'
                            },
                            {
                                label: 'Estimativa de Pessoas com Asma',
                                data: estimativa_asmaticos,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)'
                            }
                        ]
                    };

                    const ctxMunicipios = document.getElementById('graficoMunicipios').getContext('2d');

                    // PROTE√á√ÉO PARA DESTRUIR O GR√ÅFICO APENAS SE EXISTIR
                    if (window.graficoMunicipios && typeof window.graficoMunicipios.destroy === 'function') {
                        window.graficoMunicipios.destroy();
                    }

                    window.graficoMunicipios = new Chart(ctxMunicipios, {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Munic√≠pios com popula√ß√£o que recebe menos de 50% de medicamentos suficientes',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 0,
                                        bottom: 5
                                    }
                                },
                                legend: {
                                    position: 'top',
                                    labels: {
                                        boxWidth: 15,
                                        padding: 5
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'logarithmic',
                                    title: {
                                        display: true,
                                        text: 'Quantidade',
                                        font: { weight: 'bold', size: 12 }
                                    },
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: false,
                                        text: 'Munic√≠pios',
                                        font: { weight: 'bold', size: 12 }
                                    },
                                    ticks: {
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => {
                    console.error("Erro no fetch:", err);
                    alert("Erro ao carregar dados do gr√°fico");
                });
        }

        // KPI DE QUANTIDADE DE PESSOAS QUE SOFREM COM ASMA

        function carregarKPIQtdPopulacao() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando quantidade de popula√ß√£o com asma para o estado:", idEstado);

            fetch(`/estados/populacaoAsma/${idEstado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO populacaoAsma()!");

                if (resposta.ok) {
                    console.log(resposta);
                    resposta.json().then(json => {
                        console.log(json); // Verifique o conte√∫do retornado
                        if (json.length > 0) {

                            qtdPopulacaoAsma.innerHTML += `${Number(json[0].estimativa_asmaticos).toLocaleString('pt-BR')}`

                        } else {
                            console.log("Popula√ß√£o com asma n√£o encontrada.");
                        }
                    });

                } else {
                    console.log("Houve um erro ao tentar realizar a busca de popula√ß√£o com asma!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            }).catch(function (erro) {
                console.log(erro);
            });
        }

        // KPI DE QUANTIDADE DE POPULA√á√ÉO ATENDIDA PELA QUANTIDADE DE MEDICAMENTOS DISPON√çVEIS

        function carregarKPIPopulacaoAtendida() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando quantidade de popula√ß√£o atendida para o estado:", idEstado);

            fetch(`/estados/populacaoAtendida/${idEstado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO populacaoAtendida()!");

                if (resposta.ok) {
                    console.log(resposta);
                    resposta.json().then(json => {
                        console.log(json); // Verifique o conte√∫do retornado
                        if (json.length > 0) {

                            var porcentagem = (json[0].periodo_atual / (json[0].estimativa_asmaticos * 30 )) * 100

                            PorcPopulacaoAtendida.innerHTML = `${porcentagem.toFixed(2)}%`

                        } else {
                            console.log("Popula√ß√£o atendida n√£o encontrada.");
                        }
                    });

                } else {
                    console.log("Houve um erro ao tentar realizar a busca de popula√ß√£o atendida!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            }).catch(function (erro) {
                console.log(erro);
            });
        }

        // KPI DE MESES COM MAIS CONSUMO

        function carregarTopMesesEstoque() {
            const idEstado = sessionStorage.FK_ESTADO;

            fetch(`/estados/topMesesEstoque/${idEstado}`)
                .then(res => {
                    if (res.status === 200) {
                        return res.json();
                    } else if (res.status === 204) {
                        throw new Error("Nenhum dado encontrado.");
                    } else {
                        throw new Error(`Erro inesperado: ${res.status}`);
                    }
                })
                .then(dados => {
                    if (dados.length === 0) throw new Error("Nenhum dado para exibir");

                    const mesesENtoPT = {
                        "January": "Janeiro",
                        "February": "Fevereiro",
                        "March": "Mar√ßo",
                        "April": "Abril",
                        "May": "Maio",
                        "June": "Junho",
                        "July": "Julho",
                        "August": "Agosto",
                        "September": "Setembro",
                        "October": "Outubro",
                        "November": "Novembro",
                        "December": "Dezembro"
                    };

                    const listaMeses = dados
                        .map(item => mesesENtoPT[item.mes] || item.mes)
                        .join("<br>");

                    document.getElementById("MesesMaisConsumo").innerHTML = listaMeses;
                })
                .catch(err => {
                    console.error("Erro ao carregar meses com mais consumo:", err.message);
                    document.getElementById("MesesMaisConsumo").textContent = "Sem dados";
                });

        }

    });
</script>

<script>
    
    document.getElementById("nomeUsuario").textContent = sessionStorage.NOME_USUARIO;

    // Buscar e exibir nome do estado pela fkEstado
    fetch(`/usuarios/nomeEstado/${sessionStorage.FK_ESTADO}`)
        .then(res => {
            if (!res.ok) throw new Error("Erro ao buscar nome do estado.");
            return res.json();
        })
        .then(data => {
            document.getElementById("fkEstado").textContent = ` (${data.nome})`;
        })
        .catch(err => {
            console.error("Erro ao buscar nome do estado:", err);
        });

    nome.value = sessionStorage.NOME_USUARIO;
    email.value = sessionStorage.EMAIL_USUARIO;
    cpf.value = sessionStorage.CPF_USUARIO;
    cargo.value = sessionStorage.CARGO_USUARIO;
    genero.value = sessionStorage.GENERO_USUARIO;
    senha.value = sessionStorage.SENHA_USUARIO;
    estado.value = sessionStorage.FK_ESTADO;
    // input_email_contato.value = sessionStorage.EMAIL_USUARIO;

    function listar2(fkEstado) {
        var fkEstado = document.getElementById('estado').value;
        fetch(`/municipios/listar/${fkEstado}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            },
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listar()!");

            if (resposta.ok) {
                console.log(resposta);
                resposta.json().then(json => {
                    console.log(json); // Verifique o conte√∫do retornado
                    if (json.length > 0) {
                        console.log("N√∫mero de usu√°rios:", json.length);

                        municipio.innerHTML = "";

                        for (let i = 0; i < json.length; i++) {
                            municipio.innerHTML += `
                            <option value="${json[i].idMunicipio}">${json[i].nome}</option>
                        `
                        }
                        municipio.value = sessionStorage.FK_MUNICIPIO;
                    } else {
                        console.log("Nenhum munic√≠pio encontrado.");
                    }
                });

            } else {
                console.log("Houve um erro ao tentar realizar a listagem!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    var dataCompleta = new Date(sessionStorage.DT_NASC);
    var dia = String(dataCompleta.getDate()).padStart(2, '0');
    var mes = String(dataCompleta.getMonth() + 1).padStart(2, '0');
    var ano = dataCompleta.getFullYear();
    var dataFormatada = `${ano}-${mes}-${dia}`;

    nascimento.value = dataFormatada;
</script>