<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InovMed | Dashboards</title>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="./js/estadual.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="./css/estadual.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="icon" href="assets/icon/logo fundo azul.png" type="image/x-icon" />

    <!-- Chart.js e adaptador date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>

    <div class="janela">

        <div class="header-left">
            <img src="./assets/imgs/logo plus branca sem fundo.png" alt="Logo InovMed" class="logo" />

            <div class="nav-icons">
                <div class="btn-nav-white active" onclick="abrirDashboard()">
                    <i class="fas fa-chart-bar"></i>
                </div>

                <div class="btn-nav" onclick="abrirPerfil()">
                    <i class="fa-solid fa-circle-user"></i>
                </div>

                <div class="btn-nav-white" id="novo_user" onclick="abrirConfiguracoes()">
                    <i class="fas fa-gear"></i>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <i class="fa-solid fa-power-off"></i>
            </div>

        </div>

        <div class="dash-estadual" id="dash_estadual">
            <div class="header-dashboard">
                <h1 class="titulo-dashboard">
                    Olá, <span id="nomeUsuario"></span>!
                </h1>
                <div class="periodo-atual">
                    <p id="titulo-periodo-atual">
                        Período atual:
                    </p>
                    <p id="periodoAtual"></p>
                </div>
            </div>
            <div class="conteudo-dashboard-estadual">
                <!-- Iniício KPIs -->

                <div class="grupo-kpi">
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">Quantidade de população que sofre com asma
                        </h3>
                        <p class="kpi-valor1" id="qtdPopulacaoAsma"></p>

                    </div>
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">% da população com asma atendida com base na quantidade de medicamento
                            disponível
                        </h3>
                        <p class="kpi-valor1" id="PorcPopulacaoAtendida"></p>

                    </div>
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">Meses com mais consumo de medicamentos
                        </h3>
                        <p class="kpi-valor1">1. Janeiro<br>
                            2. Julho
                        </p>

                    </div>
                    <!-- Final KPIs -->

                </div>
                <div class="grupo-grafico">
                    <div class="grafico-container">
                        <canvas id="graficoHistorico"></canvas>
                    </div>
                    <!-- <div class="grafico-container">
                        <canvas id="graficoBarras"></canvas>
                    </div> -->
                    <div class="grafico-container">
                        <canvas id="graficoMunicipios"></canvas>
                    </div>
                    <!-- <div class="grafico-container">
                        <canvas id="graficoVencimento"></canvas>
                    </div> -->
                </div>
            </div>

        </div>

        <div class="dash-perfil" id="dash_perfil">
            <div class="div_animacao">
                <h1 id="title_hello">Seu perfil</h1>
            </div>
            <div class="perfil-container">
                <h2 class="subtitulo">Dados Pessoais</h2>

                <div class="input-group">
                    <div class="input-item">
                        <label for="nome">Nome Completo</label>
                        <i class="fa fa-user"></i>
                        <input type="text" id="nome" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="email">E-mail</label>
                        <i class="fa fa-envelope"></i>
                        <input type="email" id="email" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="cpf">CPF</label>
                        <i class="fa fa-id-card"></i>
                        <input type="text" maxlength="11" id="cpf" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="cargo">Cargo Exercido</label>
                        <i class="fa fa-briefcase"></i>
                        <select id="cargo" class="input-field" disabled>
                            <option value="outros"></option>
                            <option value="coordenador_estadual">Coordenador Estadual</option>
                            <option value="coordenador_municipal">Coordenador Municipal</option>
                        </select>
                    </div>

                    <div class="input-item">
                        <label for="estado">Estado em que atua</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <select id="estado" class="input-field" disabled>
                            <option value="outros"></option>
                            <option value="1">Acre</option>
                            <option value="2">Amapá</option>
                            <option value="3">Amazonas</option>
                            <option value="4">Pará</option>
                            <option value="5">Rondônia</option>
                            <option value="6">Roraima</option>
                            <option value="7">Tocantins</option>
                        </select>
                    </div>
                    <div id="input_item_municipio" class="input-item" style="display: none;">
                        <label for="municipio">Município em que atua</label>
                        <i class="fa fa-map-marker-alt"></i> <!-- Ícone para municipio -->
                        <select id="municipio" class="input-field" disabled>
                        </select>
                    </div>
                    <div class="input-item">
                        <label for="nascimento">Data de Nascimento</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <input type="date" id="nascimento" class="input-field" disabled>
                    </div>
                    <div class="input-item">
                        <label for="genero">Gênero</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <select id="genero" name="genero" class="input-field" disabled>
                            <option value="">Selecione</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                            <option value="outro">Outro</option>
                            <option value="nao_informar">Prefiro não informar</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <label for="senha">Senha</label>
                        <i class="fa fa-lock"></i>
                        <input type="password" id="senha" class="input-field" disabled>
                    </div>
                </div>
                <div class="botoes-acoes">
                    <button class="btn-descartar" id="btn-descartar" onclick="descartarEdicao()" style="display: none;">
                        <i class="fas fa-times"></i> Descartar
                    </button>
                    <button class="btn-editar" id="btn-editar" onclick="editarInformacoes()">
                        <i class="fas fa-pen"></i> Editar Informações
                    </button>

                    <button class="btn-salvar" id="btn-salvar" onclick="salvarInformacoes()" style="display: none;">
                        <i class="fas fa-save"></i> Salvar Informações
                    </button>
                </div>
                <button class="delete-btn" onclick="excluirConta()">Excluir Conta</button>
            </div>
        </div>

        <div id="modal-confirm" class="modal-overlay hidden">
            <div class="modal-box">
                <h2>Tem certeza que deseja excluir sua conta?</h2>
                <p>Você não irá mais ter acessos à nossa plataforma e aos dados aqui inclusos</p>
                <div class="modal-buttons">
                    <button id="cancel-delete" class="btn cancelar">Cancelar</button>
                    <button id="confirm-delete" class="btn confirmar">Excluir Conta</button>
                </div>
            </div>
        </div>

        <div class="dash-config" id="dash_config">
            <div class="titulo-config">
                <h1>Configurações</h1>
            </div>

            <div class="opcao-config-container" id="opcao_config_container">
                <div class="opcao-config-contato" onclick="abrirContatos()">
                    <div class="texto-config">
                        <h1>
                            Contato
                        </h1>
                        <p>
                            Defina onde é importante você receber notificações sobre alertas e avisos
                        </p>
                    </div>
                    <div class="config-seta-imagem">
                        <img src="assets/icon/caret-right-light.png">
                    </div>
                </div>
                <div class="opcao-config-parametro" onclick="abrirParametros()">
                    <div class="texto-config">
                        <h1>
                            Parâmetros
                        </h1>
                        <p>
                            Defina os parâmetros e métricas que façam sentido com sua realidade
                        </p>
                    </div>
                    <div class="config-seta-imagem">
                        <img src="assets/icon/caret-right-light.png">
                    </div>
                </div>
            </div>

            <div class="dash-contato-container" id="dash_contato_container">
                <h1 class="titulo-contato">
                    Contatos
                </h1>
                <div class="contato-container">
                    <!-- <div class="contato-container-cima">
                        <h1 class="nome-contato" id="nome_contato">
                            Contato 1
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div> -->
                    <div class="contato-container-input">
                        <p class="email-contato">
                            Email
                        </p>
                        <input type="text" id="input_email_contato" disabled>
                    </div>
                    <div class="botoes-acoes-contato">
                        <button class="btn-editar" id="btn-editar-contato" onclick="editarInformacoesContato()">
                            <i class="fas fa-pen"></i> Editar Informações
                        </button>
                        <button class="btn-descartar" id="btn-descartar-contato" onclick="descartarEdicaoContato()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-contato" onclick="salvarInformacoesContato()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informações
                        </button>
                    </div>
                </div>
                <!-- <div class="adicionar-contato">
                    <div id="adicionar_contato">
                        <img src="assets/icon/plus-circle-thin.png">
                    </div>
                </div> -->
            </div>

            <div class="dash-parametro-container" id="dash_parametro_container">
                <h1 class="titulo-parametro">
                    Parâmetros
                </h1>
                <div class="parametro-container">
                    <h1 class="nome-parametro">
                        Medicamentos
                    </h1>
                    <div class="parametro-container-input">
                        <p class="menor-valor-parametro">
                            Menor quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_menor_valor">
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja menor que esse valor, te notificaremos
                        </p>
                        <p class="maior-valor-parametro">
                            Maior quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_maior_valor">
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja maior que esse valor, te notificaremos
                        </p>
                    </div>
                    <div class="botoes-acoes-parametros">
                        <button class="btn-editar" id="btn-editar-parametro" onclick="editarInformacoesParametro()">
                            <i class="fas fa-pen"></i> Editar Informações
                        </button>
                        <button class="btn-descartar" id="btn-descartar-parametro" onclick="descartarEdicaoParametro()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-parametro" onclick="salvarInformacoesParametro()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informações
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>

</html>

<script src="./js/sessao.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        carregarKPIPeriodoAtual();
        carregarGraficoHistorico();
        carregarGraficoMunicipios();
        carregarKPIQtdPopulacao();
        carregarKPIPopulacaoAtendida();

        // KPI DE PERÍODO ATUAL
        function carregarKPIPeriodoAtual() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando período atual da base:", idEstado);

            fetch(`/estados/periodoAtual/${idEstado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO periodoAtual()!");

                if (resposta.ok) {
                    console.log(resposta);
                    resposta.json().then(json => {
                        console.log(json); // Verifique o conteúdo retornado
                        if (json.length > 0) {
                            
                            periodoAtual.innerHTML = `${json[0].periodo_atual}`
                            
                        } else {
                            console.log("período atual não encontrada.");
                        }
                    });

                } else {
                    console.log("Houve um erro ao tentar realizar a busca de período atual!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            }).catch(function (erro) {
                console.log(erro);
            });
        }

        // GRÁFICO DE HISTÓRICO POR ESTADO

        function gerarMesesIntervalo(ano, mesInicio, mesFim) {
            const meses = [];
            for (let m = mesInicio; m <= mesFim; m++) {
                meses.push(`${m.toString().padStart(2, '0')}-${ano}`);
            }
            return meses;
        }

        function carregarGraficoHistorico() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando histórico para o estado:", idEstado);

            fetch(`/estados/historico/${idEstado}`)
                .then(res => {
                    if (!res.ok) throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
                    return res.json();
                })
                .then(dados => {
                    // Defina o intervalo fixo de meses que quer mostrar no gráfico:
                    const ano = 2024;
                    const mesInicio = 1;
                    const mesFim = 12;
                    const meses = gerarMesesIntervalo(ano, mesInicio, mesFim);

                    const remedios = [...new Set(dados.map(item => item.remedio))];

                    const datasets = remedios.map(remedio => ({
                        label: remedio,
                        data: meses.map(mes => {
                            const registro = dados.find(d => d.mes === mes && d.remedio === remedio);
                            return registro ? Number(registro.total_comprado) : 0;
                        }),
                        borderColor: gerarCorAleatoria(),
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 0,
                    }));

                    const mediaFixa = dados.length > 0 ? Number(dados[0].estimativa_asmaticos) : 0;

                    // Preenche a média com o valor fixo para todos os meses
                    const mediaAsmaticos = meses.map(() => mediaFixa);

                    datasets.push({
                        label: 'Média pessoas com asma',
                        data: mediaAsmaticos,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderDash: [10, 5],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                    });
                    const ctx = document.getElementById('graficoHistorico').getContext('2d');

                    // PROTEÇÃO PARA DESTRUIR O GRÁFICO APENAS SE EXISTIR
                    if (window.graficoHistorico && typeof window.graficoHistorico.destroy === 'function') {
                        window.graficoHistorico.destroy();
                    }

                    window.graficoHistorico = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: meses,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Histórico mensal de medicamentos comprados por estado',
                                    font: { size: 14, weight: 'bold' },
                                    padding: { top: 0, bottom: 5 }
                                },
                                legend: {
                                    position: 'top',
                                    labels: {
                                        boxWidth: 15,
                                        padding: 5
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Quantidade',
                                        font: { weight: 'bold', size: 12 }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Meses',
                                        font: { weight: 'bold', size: 12 }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => {
                    console.error("Erro no fetch:", err);
                    alert("Erro ao carregar dados do gráfico");
                });
        }

        function gerarCorAleatoria() {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgba(${r}, ${g}, ${b}, 1)`;
        }

        // GRÁFICO DE MUNICÍPIOS COM POPULAÇÃO QUE RECEBE MENOS DE 50% DOS MEDICAMENTOS

        function carregarGraficoMunicipios() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando municipios para o estado:", idEstado);

            fetch(`/estados/municipios/${idEstado}`)
                .then(res => {
                    if (!res.ok) throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
                    return res.json();
                })
                .then(dados => {

                    const municipios = [...new Set(dados.map(item => item.municipio))];
                    const total_comprado = [...new Set(dados.map(item => item.total_comprado))];
                    const estimativa_asmaticos = [...new Set(dados.map(item => item.estimativa_asmaticos))];

                    const data = {
                        labels: municipios,
                        datasets: [
                            {
                                label: 'Total de Medicamentos Comprados',
                                data: total_comprado,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)'
                            },
                            {
                                label: 'Estimativa de Pessoas com Asma',
                                data: estimativa_asmaticos,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)'
                            }
                        ]
                    };

                    const ctxMunicipios = document.getElementById('graficoMunicipios').getContext('2d');

                    // PROTEÇÃO PARA DESTRUIR O GRÁFICO APENAS SE EXISTIR
                    if (window.graficoMunicipios && typeof window.graficoMunicipios.destroy === 'function') {
                        window.graficoMunicipios.destroy();
                    }

                    window.graficoMunicipios = new Chart(ctxMunicipios, {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Municípios com população que recebe menos de 50% de medicamentos suficientes',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 0,
                                        bottom: 5
                                    }
                                },
                                legend: {
                                    position: 'top',
                                    labels: {
                                        boxWidth: 15,
                                        padding: 5
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'logarithmic',
                                    title: {
                                        display: true,
                                        text: 'Quantidade',
                                        font: { weight: 'bold', size: 12 }
                                    },
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: false,
                                        text: 'Municípios',
                                        font: { weight: 'bold', size: 12 }
                                    },
                                    ticks: {
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => {
                    console.error("Erro no fetch:", err);
                    alert("Erro ao carregar dados do gráfico");
                });
        }

        // KPI DE QUANTIDADE DE PESSOAS QUE SOFREM COM ASMA

        function carregarKPIQtdPopulacao() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando quantidade de população com asma para o estado:", idEstado);

            fetch(`/estados/populacaoAsma/${idEstado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO populacaoAsma()!");

                if (resposta.ok) {
                    console.log(resposta);
                    resposta.json().then(json => {
                        console.log(json); // Verifique o conteúdo retornado
                        if (json.length > 0) {
                            
                            qtdPopulacaoAsma.innerHTML += `${Number(json[0].estimativa_asmaticos).toLocaleString('pt-BR')}`
                            
                        } else {
                            console.log("População com asma não encontrada.");
                        }
                    });

                } else {
                    console.log("Houve um erro ao tentar realizar a busca de população com asma!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            }).catch(function (erro) {
                console.log(erro);
            });
        }

        // KPI DE QUANTIDADE DE POPULAÇÃO ATENDIDA PELA QUANTIDADE DE MEDICAMENTOS DISPONÍVEIS

        function carregarKPIPopulacaoAtendida() {
            const idEstado = sessionStorage.FK_ESTADO;
            console.log("Buscando quantidade de população atendida para o estado:", idEstado);

            fetch(`/estados/populacaoAtendida/${idEstado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO populacaoAtendida()!");

                if (resposta.ok) {
                    console.log(resposta);
                    resposta.json().then(json => {
                        console.log(json); // Verifique o conteúdo retornado
                        if (json.length > 0) {
                            
                            var porcentagem = (json[0].periodo_atual / (30 * json[0].estimativa_asmaticos)) * 100

                            PorcPopulacaoAtendida.innerHTML = `${porcentagem.toFixed(2)}%`
                            
                        } else {
                            console.log("População atendida não encontrada.");
                        }
                    });

                } else {
                    console.log("Houve um erro ao tentar realizar a busca de população atendida!");
                    resposta.text().then(texto => {
                        console.error(texto);
                    });
                }
            }).catch(function (erro) {
                console.log(erro);
            });
        }
    
    
    
    });
</script>

<script>
    nomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

    nome.value = sessionStorage.NOME_USUARIO;
    email.value = sessionStorage.EMAIL_USUARIO;
    cpf.value = sessionStorage.CPF_USUARIO;
    cargo.value = sessionStorage.CARGO_USUARIO;
    genero.value = sessionStorage.GENERO_USUARIO;
    senha.value = sessionStorage.SENHA_USUARIO;
    estado.value = sessionStorage.FK_ESTADO;
    input_email_contato.value = sessionStorage.EMAIL_USUARIO;
    input_parametro_menor_valor.value = 5;
    input_parametro_maior_valor.value = 10;

    function listar2(fkEstado) {
        var fkEstado = document.getElementById('estado').value;
        fetch(`/municipios/listar/${fkEstado}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            },
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listar()!");

            if (resposta.ok) {
                console.log(resposta);
                resposta.json().then(json => {
                    console.log(json); // Verifique o conteúdo retornado
                    if (json.length > 0) {
                        console.log("Número de usuários:", json.length);

                        municipio.innerHTML = "";

                        for (let i = 0; i < json.length; i++) {
                            municipio.innerHTML += `
                            <option value="${json[i].idMunicipio}">${json[i].nome}</option>
                        `
                        }
                        municipio.value = sessionStorage.FK_MUNICIPIO;
                    } else {
                        console.log("Nenhum município encontrado.");
                    }
                });

            } else {
                console.log("Houve um erro ao tentar realizar a listagem!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }

    var dataCompleta = new Date(sessionStorage.DT_NASC);
    var dia = String(dataCompleta.getDate()).padStart(2, '0');
    var mes = String(dataCompleta.getMonth() + 1).padStart(2, '0');
    var ano = dataCompleta.getFullYear();
    var dataFormatada = `${ano}-${mes}-${dia}`;

    nascimento.value = dataFormatada;
</script>