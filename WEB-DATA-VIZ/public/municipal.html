<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InovMed | Dashboards</title>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="./js/municipal.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="./css/municipal.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="icon" href="assets/icon/logo fundo azul.png" type="image/x-icon" />

    <!-- Chart.js e adaptador date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>


<body onload="validarSessao(); listar2()">

    <div class="janela">

        <div class="header-left">
            <img src="./assets/imgs/logo plus branca sem fundo.png" alt="Logo InovMed" class="logo" />

            <div class="nav-icons">
                <div class="btn-nav-white active" onclick="abrirDashboard()">
                    <i class="fas fa-chart-bar"></i>
                </div>

                <div class="btn-nav" onclick="abrirPerfil()">
                    <i class="fa-solid fa-circle-user"></i>
                </div>

                <div class="btn-nav-white" id="novo_user" onclick="abrirConfiguracoes()">
                    <i class="fas fa-gear"></i>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <i class="fa-solid fa-power-off"></i>
            </div>

        </div>

        <div class="dash-municipal" id="dash_municipal">
            <div class="header-dashboard">
                <h1 class="titulo-dashboard">
                    Ol√°, <span id="nomeUsuario"></span>!
                </h1>
                <div class="periodo-atual">
                    <p id="titulo-periodo-atual">
                        Per√≠odo atual:
                    </p>
                    <p>
                        dd/mm/aaaa
                    </p>
                </div>
            </div>
            <div class="conteudo-dashboard-municipal">
                <div class="grupo-kpi">
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">Quantidade de popula√ß√£o que sofre com asma
                        </h3>
                        <p id="valorKpi2" class="kpi-valor1"></p>
                    </div>
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">% da popula√ß√£o com asma atendida com base na quantidade de medicamento
                            dispon√≠vel</h3>
                        <p id="valorKpi" class="kpi-valor1"></p>
                    </div>
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">Meses com mais consumo de medicamentos
                        </h3>
                        <p id="valorKpi3" class="kpi-valor1"></p>
                        </p>

                    </div>
                    <!-- Final KPIs -->

                </div>

                <div class="grupo-grafico">
                    <div class="grafico-container">
                        <select id="anoSelect">
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025</option>
                        </select>
                        <canvas id="graficoTendencia"></canvas>
                    </div>
                    <div class="grafico-container">
                        <canvas id="graficoBarras"></canvas>
                    </div>
                    <div class="grafico-container">
                        <canvas id="graficoTendenciaResumo"></canvas>
                    </div>
                    <div class="grafico-container">
                        <canvas id="graficoVencimento"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <div class="dash-perfil" id="dash_perfil">
            <div class="div_animacao">
                <h1 id="title_hello">Seu perfil</h1>
            </div>
            <div class="perfil-container">
                <h2 class="subtitulo">Dados Pessoais</h2>

                <div class="input-group">
                    <div class="input-item">
                        <label for="nome">Nome Completo</label>
                        <i class="fa fa-user"></i>
                        <input type="text" id="nome" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="email">E-mail</label>
                        <i class="fa fa-envelope"></i>
                        <input type="email" id="email" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="cpf">CPF</label>
                        <i class="fa fa-id-card"></i>
                        <input type="text" maxlength="11" id="cpf" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="cargo">Cargo Exercido</label>
                        <i class="fa fa-briefcase"></i>
                        <select id="cargo" class="input-field" disabled>
                            <option value="outros"></option>
                            <option value="coordenador_estadual">Coordenador Estadual</option>
                            <option value="coordenador_municipal">Coordenador Municipal</option>
                        </select>
                    </div>

                    <div class="input-item">
                        <label for="estado">Estado em que atua</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <select id="estado" class="input-field" disabled>
                            <option value="outros"></option>
                            <option value="1">Acre</option>
                            <option value="2">Amap√°</option>
                            <option value="3">Amazonas</option>
                            <option value="4">Par√°</option>
                            <option value="5">Rond√¥nia</option>
                            <option value="6">Roraima</option>
                            <option value="7">Tocantins</option>
                        </select>
                    </div>
                    <div id="input_item_municipio" class="input-item">
                        <label for="municipio">Munic√≠pio em que atua</label>
                        <i class="fa fa-map-marker-alt"></i> <!-- √çcone para municipio -->
                        <select id="municipio" class="input-field" disabled>
                        </select>
                    </div>
                    <div class="input-item">
                        <label for="nascimento">Data de Nascimento</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <input type="date" id="nascimento" class="input-field" disabled>
                    </div>
                    <div class="input-item">
                        <label for="genero">G√™nero</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <select id="genero" name="genero" class="input-field" disabled>
                            <option value="">Selecione</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                            <option value="outro">Outro</option>
                            <option value="nao_informar">Prefiro n√£o informar</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <label for="senha">Senha</label>
                        <i class="fa fa-lock"></i>
                        <input type="password" id="senha" class="input-field" disabled>
                    </div>
                </div>
                <div class="botoes-acoes">
                    <button class="btn-descartar" id="btn-descartar" onclick="descartarEdicao()" style="display: none;">
                        <i class="fas fa-times"></i> Descartar
                    </button>
                    <button class="btn-editar" id="btn-editar" onclick="editarInformacoes()">
                        <i class="fas fa-pen"></i> Editar Informa√ß√µes
                    </button>

                    <button class="btn-salvar" id="btn-salvar" onclick="salvarInformacoes()" style="display: none;">
                        <i class="fas fa-save"></i> Salvar Informa√ß√µes
                    </button>
                </div>
                <button class="delete-btn" onclick="excluirConta()">Excluir Conta</button>
            </div>
        </div>

        <div id="modal-confirm" class="modal-overlay hidden">
            <div class="modal-box">
                <h2>Tem certeza que deseja excluir sua conta?</h2>
                <p>Voc√™ n√£o ir√° mais ter acessos √† nossa plataforma e aos dados aqui inclusos</p>
                <div class="modal-buttons">
                    <button id="cancel-delete" class="btn cancelar">Cancelar</button>
                    <button id="confirm-delete" class="btn confirmar">Excluir Conta</button>
                </div>
            </div>
        </div>

        <div class="dash-config" id="dash_config">
            <div class="titulo-config">
                <h1>Configura√ß√µes</h1>
            </div>

            <div class="opcao-config-container" id="opcao_config_container">
                <div class="opcao-config-contato" onclick="abrirContatos()">
                    <div class="texto-config">
                        <h1>
                            Contato
                        </h1>
                        <p>
                            Defina onde √© importante voc√™ receber notifica√ß√µes sobre alertas e avisos
                        </p>
                    </div>
                    <div class="config-seta-imagem">
                        <img src="assets/icon/caret-right-light.png">
                    </div>
                </div>
                <div class="opcao-config-parametro" onclick="abrirParametros()">
                    <div class="texto-config">
                        <h1>
                            Par√¢metros
                        </h1>
                        <p>
                            Defina os par√¢metros e m√©tricas que fa√ßam sentido com sua realidade
                        </p>
                    </div>
                    <div class="config-seta-imagem">
                        <img src="assets/icon/caret-right-light.png">
                    </div>
                </div>
            </div>

            
            <div class="dash-contato-container" id="dash_contato_container">
                <h1 class="titulo-contato">
                    Contatos
                </h1>

                <div id="card_contatos"></div>

                <!-- <div class="contato-container">
                    <div class="contato-container-cima">
                        <h1 class="nome-contato" id="nome_contato">
                            Contato 1
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="contato-container-input">
                        <p class="email-contato">
                            Email
                        </p>
                        <input type="text" id="input_email_contato" disabled>
                    </div>
                    <div class="botoes-acoes-contato">
                        <button class="btn-editar" id="btn-editar-contato" onclick="editarInformacoesContato()">
                            <i class="fas fa-pen"></i> Editar Informa√ß√µes
                        </button>
                        <button class="btn-descartar" id="btn-descartar-contato" onclick="descartarEdicaoContato()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-contato" onclick="salvarInformacoesContato()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informa√ß√µes
                        </button>
                    </div>
                </div> -->
                <div class="adicionar-contato">
                    <div id="adicionar_contato" onclick="adicionarCardVazio()">
                        <img src="assets/icon/plus-circle-thin.png">
                    </div>
                </div>
            </div>


            <div class="dash-parametro-container" id="dash_parametro_container">
                <h1 class="titulo-parametro">
                    Par√¢metros
                </h1>
                <div class="parametro-container">
                    <h1 class="nome-parametro">
                        Medicamentos
                    </h1>
                    <div class="parametro-container-input">
                        <p class="menor-valor-parametro">
                            Menor quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_menor_valor" disabled>
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja menor que esse valor, te notificaremos
                        </p>
                        <p class="maior-valor-parametro">
                            Maior quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_maior_valor" disabled>
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja maior que esse valor, te notificaremos
                        </p>
                    </div>
                    <div class="botoes-acoes-parametros">
                        <button class="btn-editar" id="btn-editar-parametro" onclick="editarInformacoesParametro()">
                            <i class="fas fa-pen"></i> Editar Informa√ß√µes
                        </button>
                        <button class="btn-descartar" id="btn-descartar-parametro" onclick="descartarEdicaoParametro()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-parametro" onclick="salvarInformacoesParametro()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informa√ß√µes
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const idMunicipio = sessionStorage.FK_MUNICIPIO;

            if (!idMunicipio) {
                alert("ID do munic√≠pio n√£o encontrado.");
                return;
            }

            carregarGraficoPeriodos(idMunicipio);
            carregarGraficoVencimento(idMunicipio);
            carregarGraficoTendencia(idMunicipio);

            const anoSelect = document.getElementById("anoSelect");
            if (anoSelect) {
                carregarGraficoHistorico(idMunicipio); // s√≥ chama se o select existir
                anoSelect.addEventListener("change", function () {
                    carregarGraficoHistorico(idMunicipio);
                });
            } else {
                console.warn("Elemento #anoSelect n√£o encontrado no DOM.");
            }


            function carregarGraficoPeriodos(idMunicipio) {
                fetch(`http://localhost:3333/municipios/periodos/${idMunicipio}`)
                    .then(res => res.json())
                    .then(dados => {
                        // Filtra apenas os que t√™m soma dos per√≠odos maior que 10
                        const dadosFiltrados = dados.filter(item => {
                            const soma = Number(item.periodo_anterior) + Number(item.periodo_atual);
                            return soma > 10;
                        });

                        const labels = dadosFiltrados.map(item =>
                            item.remedio.split(' ').slice(0, 4).join('\n') // quebra em at√© 3 linhas
                        );

                        const periodoAnterior = dadosFiltrados.map(item =>
                            Number(item.periodo_anterior) === 0 ? 1 : Number(item.periodo_anterior)
                        );
                        const periodoAtual = dadosFiltrados.map(item =>
                            Number(item.periodo_atual) === 0 ? 1 : Number(item.periodo_atual)
                        );

                        const ctxBarras = document.getElementById('graficoBarras');
                        if (!ctxBarras) return;

                        const ctx = ctxBarras.getContext('2d');
                        if (window.graficoBarras?.destroy) window.graficoBarras.destroy();

                        window.graficoBarras = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Per√≠odo Anterior',
                                        data: periodoAnterior,
                                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                                    },
                                    {
                                        label: 'Per√≠odo Atual',
                                        data: periodoAtual,
                                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Compara√ß√£o de quantidade de rem√©dios por per√≠odo',
                                        font: { size: 18 }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: ctx => `${ctx.dataset.label}: ${ctx.raw === 1 ? 0 : ctx.raw}`
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'logarithmic',
                                        beginAtZero: false
                                    },
                                    x: {

                                        ticks: {
                                            maxRotation: 0,
                                            minRotation: 0,
                                            autoSkip: false,
                                            callback: function (value) {
                                                const label = this.getLabelForValue(value);
                                                return label.split('\n'); // for√ßa quebra de linha real
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Erro ao carregar gr√°fico:", err);
                        alert("Erro ao carregar gr√°fico de per√≠odos.");
                    });
            }


            // === GR√ÅFICO DE HIST√ìRICO POR MUNIC√çPIO ===

            function gerarMesesIntervalo(ano, mesInicio, mesFim) {
                const meses = [];
                for (let m = mesInicio; m <= mesFim; m++) {
                    meses.push(`${ano}-${m.toString().padStart(2, '0')}`);
                }
                return meses;
            }

            const coresFixas = [
                'rgba(75, 192, 192, 1)',    // Verde
                'rgba(255, 206, 86, 1)',    // Amarelo forte
                'rgba(54, 162, 235, 1)',    // Azul
                'rgba(255, 99, 132, 1)'     // Vermelho
            ];


            function carregarGraficoHistorico(idMunicipio) {
                const anoSelecionado = document.getElementById("anoSelect").value;

                console.log(`Buscando hist√≥rico para o munic√≠pio ${idMunicipio} no ano ${anoSelecionado}`);

                fetch(`http://localhost:3333/municipios/historico/${idMunicipio}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
                        return res.json();
                    })
                    .then(dados => {
                        const mesInicio = 1;
                        const mesFim = 12;
                        const meses = gerarMesesIntervalo(anoSelecionado, mesInicio, mesFim);

                        const remedios = [...new Set(dados.map(item => item.remedio))];

                        const datasets = remedios.map((remedio, i) => {
                            const nomeCurto = remedio.split(' ').slice(0, 4).join(' ');
                            const valores = meses.map(mes => {
                                const registro = dados.find(d => d.mes === mes && d.remedio === remedio);
                                return registro ? Number(registro.total_comprado) : 0;
                            });

                            return {
                                label: nomeCurto,
                                data: valores,
                                borderColor: coresFixas[i % coresFixas.length],
                                backgroundColor: 'rgba(20, 162, 235, 1)', // voc√™ pode tamb√©m criar um array para isso se quiser variar
                                tension: 0.3,
                                borderWidth: 3,
                                pointRadius: 4
                            };
                        });


                        const ctx = document.getElementById('graficoTendencia').getContext('2d');

                        // No gr√°fico HIST√ìRICO (mensal)
                        if (window.graficoHistorico && typeof window.graficoHistorico.destroy === 'function') {
                            window.graficoHistorico.destroy();
                        }
                        window.graficoHistorico = new Chart(


                            ctx, {
                            type: 'line',
                            data: {
                                labels: meses,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                        labels: {
                                            font: { size: 12 }
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: `Hist√≥rico mensal de medicamentos - ${anoSelecionado}`,
                                        font: {
                                            size: 18,
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Erro no fetch:", err.message);
                        // alert("Erro ao carregar dados do gr√°fico");
                    });
            }

            // üîπ **Passo 3: Atualizar o gr√°fico quando o usu√°rio muda o ano**
            document.getElementById("anoSelect").addEventListener("change", carregarGraficoHistorico);



            function carregarGraficoVencimento(idMunicipio) {
                fetch(`http://localhost:3333/municipios/vencimentos/${idMunicipio}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Erro na resposta: ${res.statusText}`);
                        return res.json();
                    })
                    .then(dados => {
                        // Montar labels por lote + rem√©dio, limitado a 6 palavras
                        const labels = dados.map(item => {
                            const textoCompleto = `Lote ${item.nome} - ${item.remedio || ""}`;
                            const palavras = textoCompleto.split(' ');
                            return palavras.slice(0, 6).join(' ');
                        });

                        // Quantidade em estoque por lote
                        const estoque = dados.map(item => item.quantidade);

                        // Calcula dias para vencimento por lote
                        const hoje = new Date();
                        const diasParaVencimento = dados.map(item => {
                            const dtVenc = new Date(item.vencimento);
                            const diffTime = dtVenc - hoje;
                            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        });

                        const ctx = document.getElementById('graficoVencimento').getContext('2d');

                        if (window.graficoVencimento && typeof window.graficoVencimento.destroy === 'function') {
                            window.graficoVencimento.destroy();
                        }

                        window.graficoVencimento = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Quantidade em estoque',
                                        data: estoque,
                                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Dias para vencimento',
                                        data: diasParaVencimento,
                                        backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Rem√©dios Pr√≥ximos ao Vencimento por Lote',
                                        font: {
                                            size: 18,
                                            weight: 'bold'
                                        }
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        callbacks: {
                                            label: function (context) {
                                                if (context.dataset.label === 'Dias para vencimento') {
                                                    return `${context.dataset.label}: ${context.raw} dias`;
                                                } else {
                                                    return `${context.dataset.label}: ${context.raw} unidades`;
                                                }
                                            }
                                        }
                                    },
                                    legend: {
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'logarithmic',
                                        min: 1,
                                        title: {
                                            display: true,
                                            text: 'Quantidade / Dias (escala logar√≠tmica)',
                                            font: { size: 14, weight: 'bold' }
                                        },
                                        ticks: {
                                            callback: function (value) {
                                                return Number(value.toString()); // para mostrar n√∫meros normais
                                            }
                                        }
                                    }
                                    ,
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Lotes de Rem√©dios',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Erro ao carregar vencimentos:", err);
                        alert("Erro ao carregar gr√°fico de vencimentos.");
                    });
            }
        });
        function carregarGraficoTendencia(idMunicipio) {
            fetch(`http://localhost:3333/municipios/tendencia/${idMunicipio}`)
                .then(res => res.json())
                .then(dados => {
                    if (!dados || dados.length === 0) {
                        alert("Nenhum dado de tend√™ncia encontrado.");
                        return;
                    }

                    const tendencia = dados[0];

                    const ctx = document.getElementById('graficoTendenciaResumo').getContext('2d');
                    if (window.graficoTendenciaResumo?.destroy) window.graficoTendenciaResumo.destroy();

                    window.graficoTendenciaResumo = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['M√™s Anterior', 'M√™s Atual', 'Pr√≥ximo M√™s'],
                            datasets: [{
                                label: 'Tend√™ncia de Compra',
                                data: [
                                    tendencia.mes_anterior,
                                    tendencia.mes_atual,
                                    tendencia.previsao_proximo_mes
                                ],
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: 'white',
                                pointBorderColor: 'rgba(75, 192, 192, 1)',
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Tend√™ncia de Compra por Rem√©dio',
                                    font: { size: 18 }
                                },
                                legend: {
                                    display: true
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Quantidade Comprada'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Per√≠odo'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => {
                    console.error("Erro ao carregar gr√°fico de tend√™ncia:", err);
                    alert("Erro ao carregar gr√°fico de tend√™ncia.");
                });
        }

        function gerarCorAleatoria() {
            const r = Math.floor(Math.random() * 156) + 100;
            const g = Math.floor(Math.random() * 156) + 100;
            const b = Math.floor(Math.random() * 156) + 100;
            return `rgba(${r}, ${g}, ${b}, 0.7)`;
        }



        // ==========================================================================================================//
        // Kpis 
        document.addEventListener('DOMContentLoaded', function () {
            const idMunicipio = sessionStorage.FK_MUNICIPIO;

            console.log("ID do Munic√≠pio:", idMunicipio);

            if (!idMunicipio) {
                alert("ID do munic√≠pio n√£o encontrado.");
                return;
            }

            carregarKpiAtendimento(idMunicipio);
            carregarQtdPopulacaoAsma(idMunicipio);
            carregarTopMesesEstoque(idMunicipio);

            function carregarKpiAtendimento(idMunicipio) {
                fetch(`http://localhost:3333/municipios/kpiAtendimento/${idMunicipio}`)
                    .then(res => {
                        if (res.status === 200) {
                            return res.json();
                        } else if (res.status === 204) {
                            throw new Error("Nenhum dado encontrado.");
                        } else {
                            throw new Error(`Erro inesperado: ${res.status}`);
                        }
                    })
                    .then(dado => {
                        document.getElementById("valorKpi").textContent = `${dado.percentual_atendimento}%`;
                    })
                    .catch(err => {
                        console.error("Erro ao carregar KPI de atendimento:", err.message);
                        document.getElementById("valorKpi").textContent = "Sem dados";
                    });
            }

            function carregarQtdPopulacaoAsma(idMunicipio) {
                fetch(`http://localhost:3333/municipios/qtdPopulacaoAsma/${idMunicipio}`)
                    .then(res => {
                        if (res.status === 200) {
                            return res.json();
                        } else if (res.status === 204) {
                            throw new Error("Nenhum dado encontrado.");
                        } else {
                            throw new Error(`Erro inesperado: ${res.status}`);
                        }
                    })
                    .then(dado => {
                        // Converte para n√∫mero e formata com ponto para milhares
                        const numero = Number(dado.estimativa_asmaticos);
                        const texto = numero.toLocaleString('pt-BR');
                        document.getElementById("valorKpi2").textContent = texto;
                    })
                    .catch(err => {
                        console.error("Erro ao carregar popula√ß√£o com asma:", err.message);
                        document.getElementById("valorKpi2").textContent = "Sem dados";
                    });
            }

            function carregarTopMesesEstoque(idMunicipio) {
                fetch(`http://localhost:3333/municipios/topMesesEstoque/${idMunicipio}`)
                    .then(res => {
                        if (res.status === 200) {
                            return res.json();
                        } else if (res.status === 204) {
                            throw new Error("Nenhum dado encontrado.");
                        } else {
                            throw new Error(`Erro inesperado: ${res.status}`);
                        }
                    })
                    .then(dados => {
                        if (dados.length === 0) throw new Error("Nenhum dado para exibir");

                        const listaMeses = dados.map(item => item.mes).join("<br>");
                        document.getElementById("valorKpi3").innerHTML = listaMeses;
                    })

                    .catch(err => {
                        console.error("Erro ao carregar meses com mais consumo:", err.message);
                        document.getElementById("valorKpi3").textContent = "Sem dados";
                    });
            }
        });


    </script>



</body>

</html>
<script src="./js/sessao.js"></script>
<script>
    nomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

    nome.value = sessionStorage.NOME_USUARIO;
    email.value = sessionStorage.EMAIL_USUARIO;
    cpf.value = sessionStorage.CPF_USUARIO;
    cargo.value = sessionStorage.CARGO_USUARIO;
    genero.value = sessionStorage.GENERO_USUARIO;
    senha.value = sessionStorage.SENHA_USUARIO;
    estado.value = sessionStorage.FK_ESTADO;
    input_email_contato.value = sessionStorage.EMAIL_USUARIO;
    input_parametro_menor_valor.value = 5;
    input_parametro_maior_valor.value = 10;

    function listar2(fkEstado) {
        var fkEstado = document.getElementById('estado').value;
        fetch(`/municipios/listar/${fkEstado}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            },
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listar()!");

            if (resposta.ok) {
                console.log(resposta);
                resposta.json().then(json => {
                    console.log(json); // Verifique o conte√∫do retornado
                    if (json.length > 0) {
                        console.log("N√∫mero de usu√°rios:", json.length);

                        municipio.innerHTML = "";

                        for (let i = 0; i < json.length; i++) {
                            municipio.innerHTML += `
                            <option value="${json[i].idMunicipio}">${json[i].nome}</option>
                        `
                        }
                        municipio.value = sessionStorage.FK_MUNICIPIO;
                    } else {
                        console.log("Nenhum munic√≠pio encontrado.");
                    }
                });

            } else {
                console.log("Houve um erro ao tentar realizar a listagem!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }




    var dataCompleta = new Date(sessionStorage.DT_NASC);
    var dia = String(dataCompleta.getDate()).padStart(2, '0');
    var mes = String(dataCompleta.getMonth() + 1).padStart(2, '0');
    var ano = dataCompleta.getFullYear();
    var dataFormatada = `${ano}-${mes}-${dia}`;

    nascimento.value = dataFormatada;

</script>

</html>