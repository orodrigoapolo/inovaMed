<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InovMed | Dashboards</title>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="./js/municipal.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link rel="stylesheet" href="./css/municipal.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="icon" href="assets/icon/logo fundo azul.png" type="image/x-icon" />

    <!-- Chart.js e adaptador date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>


<body onload="validarSessao(); listar2()">

    <div class="janela">

        <div class="header-left">
            <img src="./assets/imgs/logo plus branca sem fundo.png" alt="Logo InovMed" class="logo" />

            <div class="nav-icons">
                <div class="btn-nav-white active" onclick="abrirDashboard()">
                    <i class="fas fa-chart-bar"></i>
                </div>

                <div class="btn-nav" onclick="abrirPerfil()">
                    <i class="fa-solid fa-circle-user"></i>
                </div>

                <div class="btn-nav-white" id="novo_user" onclick="abrirConfiguracoes()">
                    <i class="fas fa-gear"></i>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <i class="fa-solid fa-power-off"></i>
            </div>

        </div>

        <div class="dash-municipal" id="dash_municipal">
            <div class="header-dashboard">
                <h1 class="titulo-dashboard">
                    Olá, <span id="nomeUsuario"></span>!
                </h1>
                <div class="periodo-atual">
                    <p id="titulo-periodo-atual">
                        Período atual:
                    </p>
                    <p>
                        dd/mm/aaaa
                    </p>
                </div>
            </div>
            <div class="conteudo-dashboard-municipal">
                <div class="grupo-kpi">
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">Quantidade de população que sofre com asma
                        </h3>
                        <p id="valorKpi2" class="kpi-valor1"></p>
                    </div>
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">% da população com asma atendida com base na quantidade de medicamento
                            disponível</h3>
                        <p id="valorKpi" class="kpi-valor1"></p>
                    </div>
                    <div class="kpi-container">
                        <h3 class="kpi-titulo">Meses com mais consumo de medicamentos
                        </h3>
                   <p id="valorKpi3" class="kpi-valor1"></p>
                            </p>

                    </div>
                    <!-- Final KPIs -->

                </div>

                <div class="grupo-grafico">
                    <div class="grafico-container">
                        <canvas id="graficoTendencia"></canvas>
                    </div>
                    <div class="grafico-container">
                        <canvas id="graficoBarras"></canvas>
                    </div>
                    <div class="grafico-container">
                        <canvas id="graficoTendenciaResumo"></canvas>
                    </div>
                    <div class="grafico-container">
                        <canvas id="graficoVencimento"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <div class="dash-perfil" id="dash_perfil">
            <div class="div_animacao">
                <h1 id="title_hello">Seu perfil</h1>
            </div>
            <div class="perfil-container">
                <h2 class="subtitulo">Dados Pessoais</h2>

                <div class="input-group">
                    <div class="input-item">
                        <label for="nome">Nome Completo</label>
                        <i class="fa fa-user"></i>
                        <input type="text" id="nome" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="email">E-mail</label>
                        <i class="fa fa-envelope"></i>
                        <input type="email" id="email" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="cpf">CPF</label>
                        <i class="fa fa-id-card"></i>
                        <input type="text" maxlength="11" id="cpf" class="input-field" disabled>
                    </div>

                    <div class="input-item">
                        <label for="cargo">Cargo Exercido</label>
                        <i class="fa fa-briefcase"></i>
                        <select id="cargo" class="input-field" disabled>
                            <option value="outros"></option>
                            <option value="coordenador_estadual">Coordenador Estadual</option>
                            <option value="coordenador_municipal">Coordenador Municipal</option>
                        </select>
                    </div>

                    <div class="input-item">
                        <label for="estado">Estado em que atua</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <select id="estado" class="input-field" disabled>
                            <option value="outros"></option>
                            <option value="1">Acre</option>
                            <option value="2">Amapá</option>
                            <option value="3">Amazonas</option>
                            <option value="4">Pará</option>
                            <option value="5">Rondônia</option>
                            <option value="6">Roraima</option>
                            <option value="7">Tocantins</option>
                        </select>
                    </div>
                    <div id="input_item_municipio" class="input-item">
                        <label for="municipio">Município em que atua</label>
                        <i class="fa fa-map-marker-alt"></i> <!-- Ícone para municipio -->
                        <select id="municipio" class="input-field" disabled>
                        </select>
                    </div>
                    <div class="input-item">
                        <label for="nascimento">Data de Nascimento</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <input type="date" id="nascimento" class="input-field" disabled>
                    </div>
                    <div class="input-item">
                        <label for="genero">Gênero</label>
                        <i class="fa fa-map-marker-alt"></i>
                        <select id="genero" name="genero" class="input-field" disabled>
                            <option value="">Selecione</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                            <option value="outro">Outro</option>
                            <option value="nao_informar">Prefiro não informar</option>
                        </select>
                    </div>
                    <div class="input-item">
                        <label for="senha">Senha</label>
                        <i class="fa fa-lock"></i>
                        <input type="password" id="senha" class="input-field" disabled>
                    </div>
                </div>
                <div class="botoes-acoes">
                    <button class="btn-descartar" id="btn-descartar" onclick="descartarEdicao()" style="display: none;">
                        <i class="fas fa-times"></i> Descartar
                    </button>
                    <button class="btn-editar" id="btn-editar" onclick="editarInformacoes()">
                        <i class="fas fa-pen"></i> Editar Informações
                    </button>

                    <button class="btn-salvar" id="btn-salvar" onclick="salvarInformacoes()" style="display: none;">
                        <i class="fas fa-save"></i> Salvar Informações
                    </button>
                </div>
                <button class="delete-btn" onclick="excluirConta()">Excluir Conta</button>
            </div>
        </div>

        <div id="modal-confirm" class="modal-overlay hidden">
            <div class="modal-box">
                <h2>Tem certeza que deseja excluir sua conta?</h2>
                <p>Você não irá mais ter acessos à nossa plataforma e aos dados aqui inclusos</p>
                <div class="modal-buttons">
                    <button id="cancel-delete" class="btn cancelar">Cancelar</button>
                    <button id="confirm-delete" class="btn confirmar">Excluir Conta</button>
                </div>
            </div>
        </div>

        <div class="dash-config" id="dash_config">
            <div class="titulo-config">
                <h1>Configurações</h1>
            </div>

            <div class="opcao-config-container" id="opcao_config_container">
                <div class="opcao-config-contato" onclick="abrirContatos()">
                    <div class="texto-config">
                        <h1>
                            Contato
                        </h1>
                        <p>
                            Defina onde é importante você receber notificações sobre alertas e avisos
                        </p>
                    </div>
                    <div class="config-seta-imagem">
                        <img src="assets/icon/caret-right-light.png">
                    </div>
                </div>
                <div class="opcao-config-parametro" onclick="abrirParametros()">
                    <div class="texto-config">
                        <h1>
                            Parâmetros
                        </h1>
                        <p>
                            Defina os parâmetros e métricas que façam sentido com sua realidade
                        </p>
                    </div>
                    <div class="config-seta-imagem">
                        <img src="assets/icon/caret-right-light.png">
                    </div>
                </div>
            </div>

            
            <div class="dash-contato-container" id="dash_contato_container">
                <h1 class="titulo-contato">
                    Contatos
                </h1>

                <div id="card_contatos"></div>

                <!-- <div class="contato-container">
                    <div class="contato-container-cima">
                        <h1 class="nome-contato" id="nome_contato">
                            Contato 1
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="contato-container-input">
                        <p class="email-contato">
                            Email
                        </p>
                        <input type="text" id="input_email_contato" disabled>
                    </div>
                    <div class="botoes-acoes-contato">
                        <button class="btn-editar" id="btn-editar-contato" onclick="editarInformacoesContato()">
                            <i class="fas fa-pen"></i> Editar Informações
                        </button>
                        <button class="btn-descartar" id="btn-descartar-contato" onclick="descartarEdicaoContato()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-contato" onclick="salvarInformacoesContato()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informações
                        </button>
                    </div>
                </div> -->
                <div class="adicionar-contato">
                    <div id="adicionar_contato" onclick="adicionarCardVazio()">
                        <img src="assets/icon/plus-circle-thin.png">
                    </div>
                </div>
            </div>


           <div class="dash-parametro-container" id="dash_parametro_container">
                <h1 class="titulo-parametro">
                    Parâmetros
                </h1>

                <div id="card_parametro_medicamento"></div>
                <!-- <div class="parametro-container" id="parametro-medicamento">
                    <div class="parametro-container-cima">
                        <h1 class="nome-parametro">
                        Medicamentos
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="parametro-container-input">
                        <p class="menor-valor-parametro">
                            Menor quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_menor_valor" disabled>
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja menor que esse valor, te notificaremos
                        </p>
                        <p class="maior-valor-parametro">
                            Maior quantidade (unidades)
                        </p>
                        <input type="text" id="input_parametro_maior_valor" disabled>
                        <p class="descricao-input-parametro">
                            Caso a quantidade de medicamentos esteja maior que esse valor, te notificaremos
                        </p>
                    </div>
                    <div class="botoes-acoes-parametros">
                        <button class="btn-editar" id="btn-editar-parametro-medicamento" onclick="editarInformacoesParametroMedicamento()">
                            <i class="fas fa-pen"></i> Editar Informações
                        </button>
                        <button class="btn-descartar" id="btn-descartar-parametro-medicamento" onclick="descartarEdicaoParametroMedicamento()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-parametro-medicamento" onclick="salvarInformacoesParametroMedicamento()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informações
                    </div>
                </div> -->

                <div id="card_parametro_grafico"></div>
                <!-- <div class="parametro-container" id="parametro-grafico">
                    <div class="parametro-container-cima">
                        <h1 class="nome-parametro">
                        Gráfico - remédios comprados por pessoas com asma por municipio
                        </h1>
                        <div class="excluir-contato">
                            <img src="assets/icon/trash.png">
                        </div>
                    </div>
                    <div class="parametro-container-input">
                        <p class="menor-valor-parametro">
                            Porcentagem
                        </p>
                        <input type="text" id="input_parametro_grafico" disabled>
                        <p class="descricao-input-parametro">
                            Configure a porcentagem desejada para alterar a visualização do gráfico.
                        </p>
                    </div>
                    <div class="botoes-acoes-parametros">
                        <button class="btn-editar" id="btn-editar-parametro-grafico" onclick="editarInformacoesParametroGrafico()">
                            <i class="fas fa-pen"></i> Editar Informações
                        </button>
                        <button class="btn-descartar" id="btn-descartar-parametro-grafico" onclick="descartarEdicaoParametroGrafico()"
                            style="display: none;">
                            <i class="fas fa-times"></i> Descartar
                        </button>
                        <button class="btn-salvar" id="btn-salvar-parametro-grafico" onclick="salvarInformacoesParametroGrafico()"
                            style="display: none;">
                            <i class="fas fa-save"></i> Salvar Informações
                    </div>
                </div> -->

                <div id="mensagem-parametro-inexistente"></div>


                <div id="modal_parametro" class="modal-overlay hidden">
                    <div class="modal-box">
                        <h2>Qual parâmetro você gostaria de adicionar?</h2>
                        <select id="select_parametro" class="select-parametro">
                            <option value="medicamento">Medicamento</option>
                            <option value="grafico">Gráfico</option>
                        </select>
                        <div class="modal-buttons">
                            <button id="cancel_add_parametro" class="btn-cancelar-parametro">Cancelar</button>
                            <button id="confirm_add_parametro" class="btn-confirmar-parametro">Adicionar Parâmetro</button>
                        </div>
                    </div>
                </div>

                <div class="adicionar-contato">
                    <div id="adicionar_contato" onclick="criarModalParametro()">
                        <img src="assets/icon/plus-circle-thin.png">
                    </div>
                </div>
            </div>
        
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const idMunicipio = sessionStorage.FK_MUNICIPIO;

            console.log("ID do Município:", idMunicipio);

            if (!idMunicipio) {
                alert("ID do município não encontrado.");
                return;
            }

            carregarGraficoPeriodos(idMunicipio);

            function carregarGraficoPeriodos(idMunicipio) {
                fetch(`http://localhost:3333/municipios/periodos/${idMunicipio}`)
                    .then(res => res.json())
                    .then(dados => {
                        // Filtra apenas os que têm soma dos períodos maior que 10
                        const dadosFiltrados = dados.filter(item => {
                            const soma = Number(item.periodo_anterior) + Number(item.periodo_atual);
                            return soma > 10;
                        });

                        const labels = dadosFiltrados.map(item =>
                            item.remedio.split(' ').slice(0, 4).join('\n') // quebra em até 3 linhas
                        );

                        const periodoAnterior = dadosFiltrados.map(item =>
                            Number(item.periodo_anterior) === 0 ? 1 : Number(item.periodo_anterior)
                        );
                        const periodoAtual = dadosFiltrados.map(item =>
                            Number(item.periodo_atual) === 0 ? 1 : Number(item.periodo_atual)
                        );

                        const ctxBarras = document.getElementById('graficoBarras');
                        if (!ctxBarras) return;

                        const ctx = ctxBarras.getContext('2d');
                        if (window.graficoBarras?.destroy) window.graficoBarras.destroy();

                        window.graficoBarras = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'Período Anterior',
                                        data: periodoAnterior,
                                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                                    },
                                    {
                                        label: 'Período Atual',
                                        data: periodoAtual,
                                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Comparação de quantidade de remédios por período',
                                        font: { size: 18 }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: ctx => `${ctx.dataset.label}: ${ctx.raw === 1 ? 0 : ctx.raw}`
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        type: 'logarithmic',
                                        beginAtZero: false
                                    },
                                    x: {

                                        ticks: {
                                            maxRotation: 0,
                                            minRotation: 0,
                                            autoSkip: false,
                                            callback: function (value) {
                                                const label = this.getLabelForValue(value);
                                                return label.split('\n'); // força quebra de linha real
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Erro ao carregar gráfico:", err);
                        alert("Erro ao carregar gráfico de períodos.");
                    });
            }


            // === GRÁFICO DE HISTÓRICO POR MUNICÍPIO ===

            function gerarMesesIntervalo(ano, mesInicio, mesFim) {
                const meses = [];
                for (let m = mesInicio; m <= mesFim; m++) {
                    meses.push(`${ano}-${m.toString().padStart(2, '0')}`);
                }
                return meses;
            }
            carregarGraficoHistorico();

            function carregarGraficoHistorico() {
                const idMunicipio = sessionStorage.FK_MUNICIPIO;
                console.log("Buscando histórico para o município:", idMunicipio);

                fetch(`http://localhost:3333/municipios/historico/${idMunicipio}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
                        return res.json();
                    })
                    .then(dados => {
                        const ano = 2024;
                        const mesInicio = 1;
                        const mesFim = 12;
                        const meses = gerarMesesIntervalo(ano, mesInicio, mesFim);

                        const remedios = [...new Set(dados.map(item => item.remedio))];

                        const datasets = remedios.map(remedio => {
                            const nomeCurto = remedio.split(' ').slice(0, 4).join(' ');
                            const valores = meses.map(mes => {
                                const registro = dados.find(d => d.mes === mes && d.remedio === remedio);
                                return registro ? Number(registro.total_comprado) : 0;
                            });

                            return {
                                label: nomeCurto,
                                data: valores,
                                borderColor: gerarCorAleatoria(),
                                backgroundColor: 'transparent',
                                tension: 0.3,
                                borderWidth: 2,
                                pointRadius: 4
                            };
                        });

                        const mediaFixa = dados.length > 0 ? Number(dados[0].estimativa_asmaticos) : 0;
                        const mediaAsmaticos = meses.map(() => mediaFixa);

                        datasets.push({
                            label: 'Média asma',
                            data: mediaAsmaticos,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderDash: [10, 5],
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0
                        });

                        const ctx = document.getElementById('graficoTendencia').getContext('2d');

                        if (window.graficoTendencia && typeof window.graficoTendencia.destroy === 'function') {
                            window.graficoTendencia.destroy();
                        }

                        window.graficoTendencia = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: meses,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'top',
                                        labels: {
                                            font: { size: 12 }
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Histórico mensal de medicamentos comprados por município',
                                        font: {
                                            size: 18,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        suggestedMax: 100000,
                                        ticks: {
                                            stepSize: 10000,
                                            callback: value => value.toLocaleString('pt-BR')
                                        },
                                        title: {
                                            display: true,
                                            text: 'Quantidade',
                                            font: { size: 14, weight: 'bold' }
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Meses',
                                            font: { size: 14, weight: 'bold' }
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Erro no fetch:", err.message);
                        alert("Erro ao carregar dados do gráfico");
                    });
            }



            carregarGraficoVencimento();

            function carregarGraficoVencimento() {
                const idMunicipio = sessionStorage.FK_MUNICIPIO;

                fetch(`http://localhost:3333/municipios/vencimentos/${idMunicipio}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Erro na resposta: ${res.statusText}`);
                        return res.json();
                    })
                    .then(dados => {
                        console.log("Dados recebidos:", dados);

                        // === Montagem dos dados para o gráfico ===
                        const vistos = new Set();
                        const dadosUnicos = [];

                        dados.forEach(item => {
                            const nomeRemedio = item.remedio.trim().toLowerCase();
                            if (!vistos.has(nomeRemedio)) {
                                dadosUnicos.push(item);
                                vistos.add(nomeRemedio);
                            }
                        });

                        const labels = dadosUnicos.map(item => {
                            const textoCompleto = `Lote ${item.nome} - ${item.remedio}`;
                            const palavras = textoCompleto.split(' ');
                            return palavras.slice(0, 4).join(' ');
                        });
                        const data = dadosUnicos.map(item => item.quantidade);
                        const backgroundColors = dadosUnicos.map(() => gerarCorAleatoria());
                        const datasVencimento = dadosUnicos.map(item => item.vencimento);

                        const ctx = document.getElementById('graficoVencimento').getContext('2d');

                        // Destroi o gráfico anterior se ele já existir
                        if (window.graficoVencimento && typeof window.graficoVencimento.destroy === 'function') {
                            window.graficoVencimento.destroy();
                        }

                        // Cria novo gráfico
                        window.graficoVencimento = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels, // ex: "Lote 123 - Dipirona"
                                datasets: [{
                                    label: 'Quantidade',
                                    data: data,
                                    backgroundColor: backgroundColors,
                                    borderColor: backgroundColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                indexAxis: 'y', // barras horizontais
                                responsive: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Remédios Próximos ao Vencimento',
                                        font: {
                                            size: 18,
                                            weight: 'bold'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                const index = context.dataIndex;
                                                return `${context.label}: ${context.raw} unidades (vencimento: ${datasVencimento[index]})`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Quantidade',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Lotes',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Erro ao carregar vencimentos:", err);
                        alert("Erro ao carregar gráfico de vencimentos.");
                    });
            }

            // Função auxiliar para gerar cores aleatórias
            function gerarCorAleatoria() {
                const r = Math.floor(Math.random() * 156) + 100;
                const g = Math.floor(Math.random() * 156) + 100;
                const b = Math.floor(Math.random() * 156) + 100;
                return `rgba(${r}, ${g}, ${b}, 0.7)`;
            }





            // === GRÁFICO DE TENDÊNCIA RESUMO ===
            const ctxTendencia2 = document.getElementById('graficoTendenciaResumo').getContext('2d');
            const graficoTendencia2 = new Chart(ctxTendencia2, {
                type: 'line',
                data: {
                    labels: ['Mês Anterior', 'Mês Atual', 'Próximo Mês'],
                    datasets: [
                        {
                            label: 'Remédio X',
                            data: [80, 90, 120],
                            borderColor: 'rgba(30, 144, 255, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(173, 216, 230, 1)'
                        },
                        {
                            label: 'Remédio Y',
                            data: [90, 60, 70],
                            borderColor: 'rgba(34, 139, 34, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(144, 238, 144, 1)'
                        },
                        {
                            label: 'Remédio Z',
                            data: [20, 40, 65],
                            borderColor: 'rgba(255, 204, 0, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(255, 255, 102, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendência de Compra por Remédio',
                            font: { size: 18, weight: 'bold' },
                            padding: { top: 10, bottom: 20 }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 20,
                                padding: 10
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade Comprada',
                                font: { weight: 'bold', size: 14 }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Período',
                                font: { weight: 'bold', size: 14 }
                            },
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });

        });

        // ==========================================================================================================//
        // Kpis 
       document.addEventListener('DOMContentLoaded', function () {
    const idMunicipio = sessionStorage.FK_MUNICIPIO;

    console.log("ID do Município:", idMunicipio);

    if (!idMunicipio) {
        alert("ID do município não encontrado.");
        return;
    }

    carregarKpiAtendimento(idMunicipio);
    carregarQtdPopulacaoAsma(idMunicipio);
    carregarTopMesesEstoque(idMunicipio);

    function carregarKpiAtendimento(idMunicipio) {
        fetch(`http://localhost:3333/municipios/kpiAtendimento/${idMunicipio}`)
            .then(res => {
                if (res.status === 200) {
                    return res.json();
                } else if (res.status === 204) {
                    throw new Error("Nenhum dado encontrado.");
                } else {
                    throw new Error(`Erro inesperado: ${res.status}`);
                }
            })
            .then(dado => {
                document.getElementById("valorKpi").textContent = `${dado.percentual_atendimento}%`;
            })
            .catch(err => {
                console.error("Erro ao carregar KPI de atendimento:", err.message);
                document.getElementById("valorKpi").textContent = "Sem dados";
            });
    }

    function carregarQtdPopulacaoAsma(idMunicipio) {
        fetch(`http://localhost:3333/municipios/qtdPopulacaoAsma/${idMunicipio}`)
            .then(res => {
                if (res.status === 200) {
                    return res.json();
                } else if (res.status === 204) {
                    throw new Error("Nenhum dado encontrado.");
                } else {
                    throw new Error(`Erro inesperado: ${res.status}`);
                }
            })
 .then(dado => {
    // Converte para número e formata com ponto para milhares
    const numero = Number(dado.estimativa_asmaticos);
    const texto = numero.toLocaleString('pt-BR');
    document.getElementById("valorKpi2").textContent = texto;
})
            .catch(err => {
                console.error("Erro ao carregar população com asma:", err.message);
                document.getElementById("valorKpi2").textContent = "Sem dados";
            });
    }

    function carregarTopMesesEstoque(idMunicipio) {
        fetch(`http://localhost:3333/municipios/topMesesEstoque/${idMunicipio}`)
            .then(res => {
                if (res.status === 200) {
                    return res.json();
                } else if (res.status === 204) {
                    throw new Error("Nenhum dado encontrado.");
                } else {
                    throw new Error(`Erro inesperado: ${res.status}`);
                }
            })
.then(dados => {
    if (dados.length === 0) throw new Error("Nenhum dado para exibir");

    const listaMeses = dados.map(item => item.mes).join("<br>");
    document.getElementById("valorKpi3").innerHTML = listaMeses;
})

            .catch(err => {
                console.error("Erro ao carregar meses com mais consumo:", err.message);
                document.getElementById("valorKpi3").textContent = "Sem dados";
            });
    }
});


    </script>



</body>

</html>
<script src="./js/sessao.js"></script>
<script>
    nomeUsuario.innerHTML = sessionStorage.NOME_USUARIO;

    nome.value = sessionStorage.NOME_USUARIO;
    email.value = sessionStorage.EMAIL_USUARIO;
    cpf.value = sessionStorage.CPF_USUARIO;
    cargo.value = sessionStorage.CARGO_USUARIO;
    genero.value = sessionStorage.GENERO_USUARIO;
    senha.value = sessionStorage.SENHA_USUARIO;
    estado.value = sessionStorage.FK_ESTADO;
    input_email_contato.value = sessionStorage.EMAIL_USUARIO;
    input_parametro_menor_valor.value = 5;
    input_parametro_maior_valor.value = 10;

    function listar2(fkEstado) {
        var fkEstado = document.getElementById('estado').value;
        fetch(`/municipios/listar/${fkEstado}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            },
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listar()!");

            if (resposta.ok) {
                console.log(resposta);
                resposta.json().then(json => {
                    console.log(json); // Verifique o conteúdo retornado
                    if (json.length > 0) {
                        console.log("Número de usuários:", json.length);

                        municipio.innerHTML = "";

                        for (let i = 0; i < json.length; i++) {
                            municipio.innerHTML += `
                            <option value="${json[i].idMunicipio}">${json[i].nome}</option>
                        `
                        }
                        municipio.value = sessionStorage.FK_MUNICIPIO;
                    } else {
                        console.log("Nenhum município encontrado.");
                    }
                });

            } else {
                console.log("Houve um erro ao tentar realizar a listagem!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        });
    }




    var dataCompleta = new Date(sessionStorage.DT_NASC);
    var dia = String(dataCompleta.getDate()).padStart(2, '0');
    var mes = String(dataCompleta.getMonth() + 1).padStart(2, '0');
    var ano = dataCompleta.getFullYear();
    var dataFormatada = `${ano}-${mes}-${dia}`;

    nascimento.value = dataFormatada;

</script>

</html>